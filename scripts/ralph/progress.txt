# Ralph Progress Log
Started: Sun Feb  1 00:05:22 EST 2026
---

## Codebase Patterns
- Use `npm run check` to run typecheck + tests together
- Babylon.js mocks in tests need `class` syntax (not arrow functions) for Vitest 4 constructors
- Use `await import("@babylonjs/core")` (not `require`) to access mocked modules in test assertions
- Port 5173+ may be occupied by other Vite apps; check output for actual port assigned
- Game class pattern: constructor takes canvas, initializes Engine → Scene → Camera → Light → meshes
- FlightInput interface decouples input from entities — Aircraft reads from FlightInput, not keyboard
- Mock Scene constructor needs cast: `new (Scene as unknown as new () => Scene)()` for typecheck
- Default GitHub PR base may not be `master` — always use `--base master` with `gh pr create`
- ECS-like pattern: entities hold state, systems operate on entities (FlightSystem updates Aircraft)
- `@babylonjs/gui` mocks also need class syntax for StackPanel, Slider, TextBlock (used with `new`)
- FlightSystem.params is mutable — DebugPanel sliders write directly to it for real-time tuning
- Use `vi.hoisted()` for mock functions referenced inside `vi.mock()` factories (hoisting issue)
- Skybox uses `infiniteDistance = true` so it always renders behind everything
- Terrain at 4000x4000 units is large enough for extended flight without reaching edges
- FlightInput interface now includes `fire: boolean` and `cycleTarget: boolean` — all mock inputs must include both
- ScreenShake tests need deterministic `Math.random` mock to avoid flaky magnitude comparisons
- `Ellipse` from `@babylonjs/gui` needs class-style mock (used by TargetingSystem reticle/lead marker)
- Projectile direction uses same math as FlightSystem: `sin(rotY)` for X, `cos(rotY)` for Z
- AIInput implements FlightInput with mutable fields — AISystem writes, Aircraft reads
- Aircraft constructor accepts optional name and color options for distinguishing enemy meshes
- `Math.atan2(dx, dz)` gives desired yaw toward a target in Babylon's coordinate system
- Normalize angle diff to [-PI, PI] with while loops for correct shortest-path turning
- Aircraft has `health` (number) and `alive` (boolean) — systems should check `alive` before operating
- CollisionSystem uses owner-pair pattern to prevent self-hits from own weapon system
- ParticleSystem mock needs class syntax with all fields (emitter, sizes, colors, etc.)
- `Rectangle` from `@babylonjs/gui` needs class-style mock (used by HitFlash in Game.test.ts)
- Camera shake: apply additive offset AFTER CameraSystem.update() positions the camera
- `Rectangle` with `cornerRadius` makes circular radar background; use `addControl` to nest blips inside
- Heading-up radar: rotate relative positions by `cos(heading)/sin(heading)` (positive heading, not negated)
- Adding a field to FlightInput requires updating mock input objects in ALL test files (Aircraft, Camera, Collision, Flight, Weapon, Targeting)
- `Ellipse.addControl` needed in GUI mocks when nesting TextBlock inside an Ellipse (lock indicator pattern)
- Edge-triggered fire for missiles: track `prevFire` to detect press vs hold
- Lock cone check: `Math.acos(dot / dist)` gives angle between player forward and target direction

---

## 2026-02-01 - US-001
- What was implemented: Vite + TypeScript + Babylon.js project bootstrap with WASD-movable cube
- Files changed: package.json, tsconfig.json, vite.config.ts, index.html, .gitignore, src/main.ts, src/Game.ts, src/Game.test.ts
- **Tests added:** 7 new tests in src/Game.test.ts (3 scene setup + 4 movement)
- **Learnings for future iterations:**
  - Babylon.js uses `@babylonjs/core` modular imports (not monolithic `babylonjs`)
  - Vitest 4 requires class-based mocks for anything used with `new`
  - `Vector3.Zero()` is a static method — mocks need `Object.assign` or class statics
  - jsdom environment works for unit testing game logic but can't test WebGL rendering
---

## 2026-02-01 - US-002
- What was implemented: InputManager (keyboard → semantic axes) and Aircraft entity (cylinder mesh driven by FlightInput)
- Files changed: src/InputManager.ts, src/InputManager.test.ts, src/Aircraft.ts, src/Aircraft.test.ts, src/Game.ts, src/Game.test.ts
- **Tests added:** 18 new tests (12 InputManager + 6 Aircraft), Game tests updated to 5 (total 23)
- **Learnings for future iterations:**
  - FlightInput interface allows swapping input sources (keyboard, AI, network) without changing Aircraft
  - MeshBuilder.CreateCylinder with diameterTop=0 makes a cone shape (good aircraft placeholder)
  - GitHub default branch may differ from master — always specify `--base master` in `gh pr create`
  - Aircraft rotation.x = PI/2 points the cone forward (Babylon cylinders are Y-up by default)
---

## 2026-02-01 - US-003
- What was implemented: FlightSystem with velocity-based arcade movement, speed-dependent turning, stall/recovery, altitude floor, and DebugPanel with Babylon GUI sliders
- Files changed: src/FlightSystem.ts, src/FlightSystem.test.ts, src/DebugPanel.ts, src/DebugPanel.test.ts, src/Aircraft.ts, src/Aircraft.test.ts, src/Game.ts, src/Game.test.ts
- **Tests added:** 16 new tests (12 FlightSystem + 4 DebugPanel), Aircraft tests updated to 4, Game tests updated to 6 (total 38)
- **Learnings for future iterations:**
  - Aircraft.update() was removed — movement logic now lives in FlightSystem (ECS pattern)
  - Aircraft.input changed from `private` to `readonly` so systems can read it
  - Speed-dependent turn rate: `speedFactor = 1 - (speed/maxSpeed) * 0.7` gives a nice curve
  - Stall recovery: nose drops (rotation.x increases) and speed recovers automatically
  - DebugPanel uses AdvancedDynamicTexture.CreateFullscreenUI for screen-space GUI overlay
  - Babylon GUI Slider.onValueChangedObservable.add() for reactive parameter binding
  - CameraSystem uses lerp interpolation with configurable smoothing factor
  - Remove `camera.attachControl()` when using a custom CameraSystem to avoid input conflicts
---

## 2026-02-01 - US-004
- What was implemented: CameraSystem with smooth third-person chase camera, speed-dependent distance, and lerp interpolation
- Files changed: src/CameraSystem.ts, src/CameraSystem.test.ts, src/Game.ts, src/Game.test.ts
- **Tests added:** 6 new tests (5 CameraSystem + 1 Game), total now 44
- **Learnings for future iterations:**
  - FreeCamera.attachControl must be removed when CameraSystem manages positioning — otherwise built-in controls fight with custom logic
  - Lerp smoothing factor of 0.05 gives a nice smooth follow without feeling laggy
  - Speed-dependent distance formula: `baseDistance + (speed/maxSpeed) * speedDistanceScale`
  - Mock FreeCamera needs position as MockVector3 (with x/y/z), not a plain object
---

## 2026-02-01 - US-005
- What was implemented: Terrain class (4000x4000 textured ground plane) and Skybox class (large box with emissive gradient material, infinite distance)
- Files changed: src/Terrain.ts, src/Terrain.test.ts, src/Skybox.ts, src/Skybox.test.ts, src/Game.ts, src/Game.test.ts
- **Tests added:** 8 new tests (3 Terrain + 4 Skybox + 1 Game), total now 52
- **Learnings for future iterations:**
  - `vi.hoisted()` is required when mock functions need to be referenced inside `vi.mock()` factory (Vitest hoists `vi.mock` calls above variable declarations)
  - Babylon.js `infiniteDistance = true` makes skybox always render behind everything
  - `StandardMaterial.backFaceCulling = false` needed for skybox so inside faces are visible
  - `StandardMaterial.disableLighting = true` + `emissiveColor` gives a flat unlit sky color
  - 4000x4000 terrain with 32 subdivisions provides good coverage without perf issues
  - `(mock.calls[0] as unknown[])[1]` cast needed for TypeScript when accessing mock call args
---

## 2026-02-01 - US-006
- What was implemented: Projectile entity (tracer mesh, forward movement, lifetime expiry), WeaponSystem (spawns projectiles from aircraft nose, rate-of-fire cooldown), fire key (Space) added to InputManager/FlightInput
- Files changed: src/Projectile.ts, src/Projectile.test.ts, src/WeaponSystem.ts, src/WeaponSystem.test.ts, src/InputManager.ts, src/InputManager.test.ts, src/Game.ts, src/Game.test.ts, src/Aircraft.test.ts, src/CameraSystem.test.ts, src/FlightSystem.test.ts
- **Tests added:** 13 new tests (5 Projectile + 6 WeaponSystem + 1 InputManager fire + 1 Game), total now 65
- **Learnings for future iterations:**
  - Adding a field to FlightInput requires updating ALL mock input objects across test files
  - Projectile uses same direction math as FlightSystem for consistency
  - WeaponSystem cooldown of 0.15s gives a good rate of fire (~6.7 rounds/sec)
  - `as never` cast works for passing partial mock objects to typed system methods in tests
---

## 2026-02-01 - US-007
- What was implemented: AIInput (mutable FlightInput for AI), AISystem (pursuit/firing/evasion), enemy Aircraft with red color, enemy WeaponSystem, Game integration
- Files changed: src/AIInput.ts, src/AIInput.test.ts, src/AISystem.ts, src/AISystem.test.ts, src/Aircraft.ts, src/Game.ts, src/Game.test.ts
- **Tests added:** 12 new tests (8 AISystem + 2 AIInput + 2 Game), total now 77
- **Learnings for future iterations:**
  - Aircraft constructor now takes optional name and AircraftOptions (color) — backward compatible
  - AISystem.update takes `underFire` boolean — collision system will provide this in US-008
  - `Math.atan2(dx, dz)` gives desired yaw in Babylon's coordinate system (Z-forward)
  - Angle normalization to [-PI, PI] is critical for correct shortest-path steering
  - Enemy fires based on dot product angle check + distance — simple but effective
---

## 2026-02-01 - US-008
- What was implemented: CollisionSystem (bounding sphere projectile-aircraft collisions, damage, explosion VFX via ParticleSystem, ground collision detection, mission-failed state), Aircraft health/alive properties, FlightSystem skips dead aircraft, Game integration with owner-tracking to prevent self-hits, enemy underFire detection from nearby projectiles
- Files changed: src/CollisionSystem.ts, src/CollisionSystem.test.ts, src/Aircraft.ts, src/Aircraft.test.ts, src/FlightSystem.ts, src/Game.ts, src/Game.test.ts
- **Tests added:** 14 new tests (11 CollisionSystem + 2 Aircraft + 1 Game), total now 91
- **Learnings for future iterations:**
  - Owner-pair pattern: pass `{ aircraft, weaponSystem }` pairs to CollisionSystem to prevent self-hits
  - Babylon.js ParticleSystem with `targetStopDuration` + `disposeOnStop` creates self-cleaning burst effects
  - FlightSystem should check `aircraft.alive` before updating — dead aircraft shouldn't fly
  - Ground collision at altitude floor (y=2) means aircraft at terrain level are destroyed
  - `underFire` detection: check if any enemy projectile is within 100 units of the aircraft
---

## 2026-02-01 - US-009
- What was implemented: ScreenShake (decaying random camera offsets on damage), HitFlash (red GUI rectangle overlay that fades), CollisionSystem `playerHitThisFrame` flag, Game integration applying shake offsets to camera and triggering flash on player hits
- Files changed: src/ScreenShake.ts, src/ScreenShake.test.ts, src/HitFlash.ts, src/HitFlash.test.ts, src/CollisionSystem.ts, src/CollisionSystem.test.ts, src/Game.ts, src/Game.test.ts
- **Tests added:** 14 new tests (5 ScreenShake + 5 HitFlash + 2 CollisionSystem + 2 Game), total now 105
- **Learnings for future iterations:**
  - Exponential decay (`intensity *= Math.exp(-rate * dt)`) gives smooth, natural fade-out for screen effects
  - Camera shake is best applied as additive offset AFTER CameraSystem positions the camera
  - `Rectangle` from `@babylonjs/gui` needs class-style mock in Game.test.ts (like other GUI components)
  - `playerHitThisFrame` flag pattern keeps CollisionSystem decoupled from feedback systems
  - `isPointerBlocker = false` and `isHitTestVisible = false` on GUI overlays prevents them from eating input
- HUD uses `AdvancedDynamicTexture.CreateFullscreenUI` with a StackPanel for layout — same pattern as DebugPanel
- WeaponSystem has `ammo` field (default 200) — decrements on fire, stops firing at 0
---

## 2026-02-01 - US-010
- What was implemented: HUD class with speed, altitude, heading, ammo, and health text indicators using Babylon GUI; WeaponSystem ammo tracking (200 rounds, stops firing at 0); Game integration updating HUD each frame
- Files changed: src/Hud.ts, src/Hud.test.ts, src/WeaponSystem.ts, src/WeaponSystem.test.ts, src/Game.ts, src/Game.test.ts
- **Tests added:** 11 new tests (8 Hud + 2 WeaponSystem + 1 Game), total now 116
- **Learnings for future iterations:**
  - HUD StackPanel at bottom-left with `VERTICAL_ALIGNMENT_BOTTOM` keeps it out of gameplay view
  - Green text (#00ff88) on dark background is readable without being distracting
  - Heading normalization: convert radians to degrees, mod 360, add 360 if negative
  - WeaponSystem ammo field is public for HUD to read — pass ammo count to `hud.update()`
  - Multiple AdvancedDynamicTexture fullscreen UIs can coexist (DebugPanel, HitFlash, HUD)
---

## 2026-02-01 - US-011
- What was implemented: TargetingSystem with target reticle (Ellipse overlay), lead indicator for deflection shooting, Tab key cycle-target, distance readout; InputManager cycleTarget via Tab; AIInput cycleTarget field; fixed flaky ScreenShake tests with deterministic Math.random mock
- Files changed: src/TargetingSystem.ts, src/TargetingSystem.test.ts, src/InputManager.ts, src/InputManager.test.ts, src/AIInput.ts, src/Game.ts, src/Game.test.ts, src/ScreenShake.test.ts, src/Aircraft.test.ts, src/CameraSystem.test.ts, src/CollisionSystem.test.ts, src/FlightSystem.test.ts, src/WeaponSystem.test.ts
- **Tests added:** 10 new tests (8 TargetingSystem + 1 InputManager + 1 Game), total now 126
- **Learnings for future iterations:**
  - Adding a field to FlightInput requires updating ALL mock input objects across ALL test files
  - Lead indicator uses frame-to-frame position delta to estimate target velocity, then projects forward by distance/bulletSpeed
  - `Ellipse` from `@babylonjs/gui` is a good shape for reticle/lead marker overlays
  - `WeakMap` works well for per-entity state that auto-cleans when entities are garbage collected
  - ScreenShake tests were flaky due to Math.random — fixed by mocking with deterministic sequence
  - Screen-space projection: project world pos to camera plane using dot products with camera right/up/forward vectors
---

## 2026-02-01 - US-012
- What was implemented: Radar class — 2D top-down minimap in bottom-right corner showing enemy (red) and friendly (green) blips relative to centered player dot (white), with heading-up rotation and range scaling
- Files changed: src/Radar.ts, src/Radar.test.ts, src/Game.ts, src/Game.test.ts
- **Tests added:** 10 new tests (9 Radar + 1 Game), total now 136
- **Learnings for future iterations:**
  - `Rectangle` with `cornerRadius = size/2` creates a circular container for radar background
  - Heading-up rotation uses positive heading angle (not negated) with standard cos/sin rotation matrix
  - Blip pool pattern: grow pool lazily, hide excess blips — avoids creating/destroying GUI elements each frame
  - `rgba(0, 0, 0, 0.5)` background on Rectangle gives a nice semi-transparent radar overlay
  - Game.test.ts MockRectangle needed `cornerRadius`, `paddingRight`, `paddingTop`, `addControl` for Radar
---

## 2026-02-01 - US-013
- What was implemented: MissileLockSystem with state machine (Idle → Locking → Locked), Missile homing entity with limited turn rate, lock-on HUD indicator with progress %, R key for lock, missile ammo on HUD (MSL: 4), FlightInput lockOn field added
- Files changed: src/Missile.ts, src/Missile.test.ts, src/MissileLockSystem.ts, src/MissileLockSystem.test.ts, src/InputManager.ts, src/InputManager.test.ts, src/AIInput.ts, src/Hud.ts, src/Game.ts, src/Game.test.ts, + 6 test files updated for lockOn field
- **Tests added:** 18 new tests (6 Missile + 10 MissileLockSystem + 1 InputManager + 1 Game), total now 154
- **Learnings for future iterations:**
  - Adding a field to FlightInput requires updating ALL mock input objects across ALL test files — tedious but necessary
  - State machine pattern (enum + switch) is cleaner than boolean flags for multi-state systems like lock-on
  - Edge-triggered fire (`firePressed && !prevFire`) prevents continuous missile spam
  - Missile turn rate of 2.0 rad/s gives good gameplay — fast enough to track, slow enough to dodge
  - `Ellipse.addControl` must be in GUI mock when nesting TextBlock inside Ellipse
  - Lock cone of PI/6 (30°) half-angle feels right — not too generous, not too strict
---
