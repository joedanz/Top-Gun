# Ralph Progress Log
Started: Sun Feb  1 00:05:22 EST 2026
---

## Codebase Patterns
- Use `npm run check` to run typecheck + tests together
- Babylon.js mocks in tests need `class` syntax (not arrow functions) for Vitest 4 constructors
- Use `await import("@babylonjs/core")` (not `require`) to access mocked modules in test assertions
- Port 5173+ may be occupied by other Vite apps; check output for actual port assigned
- Game class pattern: constructor takes canvas, initializes Engine → Scene → Camera → Light → meshes
- FlightInput interface decouples input from entities — Aircraft reads from FlightInput, not keyboard
- Mock Scene constructor needs cast: `new (Scene as unknown as new () => Scene)()` for typecheck
- Default GitHub PR base may not be `master` — always use `--base master` with `gh pr create`
- ECS-like pattern: entities hold state, systems operate on entities (FlightSystem updates Aircraft)
- `@babylonjs/gui` mocks also need class syntax for StackPanel, Slider, TextBlock (used with `new`)
- FlightSystem.params is mutable — DebugPanel sliders write directly to it for real-time tuning
- Use `vi.hoisted()` for mock functions referenced inside `vi.mock()` factories (hoisting issue)
- Skybox uses `infiniteDistance = true` so it always renders behind everything
- Terrain at 4000x4000 units is large enough for extended flight without reaching edges

---

## 2026-02-01 - US-001
- What was implemented: Vite + TypeScript + Babylon.js project bootstrap with WASD-movable cube
- Files changed: package.json, tsconfig.json, vite.config.ts, index.html, .gitignore, src/main.ts, src/Game.ts, src/Game.test.ts
- **Tests added:** 7 new tests in src/Game.test.ts (3 scene setup + 4 movement)
- **Learnings for future iterations:**
  - Babylon.js uses `@babylonjs/core` modular imports (not monolithic `babylonjs`)
  - Vitest 4 requires class-based mocks for anything used with `new`
  - `Vector3.Zero()` is a static method — mocks need `Object.assign` or class statics
  - jsdom environment works for unit testing game logic but can't test WebGL rendering
---

## 2026-02-01 - US-002
- What was implemented: InputManager (keyboard → semantic axes) and Aircraft entity (cylinder mesh driven by FlightInput)
- Files changed: src/InputManager.ts, src/InputManager.test.ts, src/Aircraft.ts, src/Aircraft.test.ts, src/Game.ts, src/Game.test.ts
- **Tests added:** 18 new tests (12 InputManager + 6 Aircraft), Game tests updated to 5 (total 23)
- **Learnings for future iterations:**
  - FlightInput interface allows swapping input sources (keyboard, AI, network) without changing Aircraft
  - MeshBuilder.CreateCylinder with diameterTop=0 makes a cone shape (good aircraft placeholder)
  - GitHub default branch may differ from master — always specify `--base master` in `gh pr create`
  - Aircraft rotation.x = PI/2 points the cone forward (Babylon cylinders are Y-up by default)
---

## 2026-02-01 - US-003
- What was implemented: FlightSystem with velocity-based arcade movement, speed-dependent turning, stall/recovery, altitude floor, and DebugPanel with Babylon GUI sliders
- Files changed: src/FlightSystem.ts, src/FlightSystem.test.ts, src/DebugPanel.ts, src/DebugPanel.test.ts, src/Aircraft.ts, src/Aircraft.test.ts, src/Game.ts, src/Game.test.ts
- **Tests added:** 16 new tests (12 FlightSystem + 4 DebugPanel), Aircraft tests updated to 4, Game tests updated to 6 (total 38)
- **Learnings for future iterations:**
  - Aircraft.update() was removed — movement logic now lives in FlightSystem (ECS pattern)
  - Aircraft.input changed from `private` to `readonly` so systems can read it
  - Speed-dependent turn rate: `speedFactor = 1 - (speed/maxSpeed) * 0.7` gives a nice curve
  - Stall recovery: nose drops (rotation.x increases) and speed recovers automatically
  - DebugPanel uses AdvancedDynamicTexture.CreateFullscreenUI for screen-space GUI overlay
  - Babylon GUI Slider.onValueChangedObservable.add() for reactive parameter binding
  - CameraSystem uses lerp interpolation with configurable smoothing factor
  - Remove `camera.attachControl()` when using a custom CameraSystem to avoid input conflicts
---

## 2026-02-01 - US-004
- What was implemented: CameraSystem with smooth third-person chase camera, speed-dependent distance, and lerp interpolation
- Files changed: src/CameraSystem.ts, src/CameraSystem.test.ts, src/Game.ts, src/Game.test.ts
- **Tests added:** 6 new tests (5 CameraSystem + 1 Game), total now 44
- **Learnings for future iterations:**
  - FreeCamera.attachControl must be removed when CameraSystem manages positioning — otherwise built-in controls fight with custom logic
  - Lerp smoothing factor of 0.05 gives a nice smooth follow without feeling laggy
  - Speed-dependent distance formula: `baseDistance + (speed/maxSpeed) * speedDistanceScale`
  - Mock FreeCamera needs position as MockVector3 (with x/y/z), not a plain object
---

## 2026-02-01 - US-005
- What was implemented: Terrain class (4000x4000 textured ground plane) and Skybox class (large box with emissive gradient material, infinite distance)
- Files changed: src/Terrain.ts, src/Terrain.test.ts, src/Skybox.ts, src/Skybox.test.ts, src/Game.ts, src/Game.test.ts
- **Tests added:** 8 new tests (3 Terrain + 4 Skybox + 1 Game), total now 52
- **Learnings for future iterations:**
  - `vi.hoisted()` is required when mock functions need to be referenced inside `vi.mock()` factory (Vitest hoists `vi.mock` calls above variable declarations)
  - Babylon.js `infiniteDistance = true` makes skybox always render behind everything
  - `StandardMaterial.backFaceCulling = false` needed for skybox so inside faces are visible
  - `StandardMaterial.disableLighting = true` + `emissiveColor` gives a flat unlit sky color
  - 4000x4000 terrain with 32 subdivisions provides good coverage without perf issues
  - `(mock.calls[0] as unknown[])[1]` cast needed for TypeScript when accessing mock call args
---
